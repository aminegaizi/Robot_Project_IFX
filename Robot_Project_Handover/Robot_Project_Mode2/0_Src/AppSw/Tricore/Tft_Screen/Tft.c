/*
 * Tft.c
 *
 *  Created on: 07.02.2019
 *      Author: Gaizi
 *
 *      This code was taken from the Free Entry Toolchain Demo
 *      For more details
 *      	- Look at the Free Entry Toolchain demo
 *      	- Look for the Application Kit Manual and search for the Tft screen information
 *
 */

#include "Tft.h"

#ifndef FALSE
#define FALSE	0
#endif /* FALSE */
#ifndef TRUE
#define TRUE	1
#endif /* TRUE */

#define is_digit(c)		((c >= '0') && (c <= '9'))

Ifx_STM *stm0 = &MODULE_STM0;
static unsigned short TextColor = COLOR_BLACK;
static unsigned short BackColor = COLOR_WHITE;
static unsigned short DriverCode;

static void glcd_set_position(unsigned int x, unsigned int y);
static void glcd_start_GRAM_write(void);
static void wr_cmd_endless(unsigned int cmd);
static void wr_dat_endless(unsigned int c);
static void wr_end_transfer(void);
static void wr_reg(unsigned int reg, unsigned int val);
static unsigned short get_id_code(void);
static unsigned short rd_reg(unsigned int reg);
static unsigned short rd_reg_endless(unsigned int reg);
static unsigned short rd_dat_endless(void);
static void glcd_set_graph_window(unsigned int x0, unsigned int x1, unsigned int y0, unsigned int y1);
static void GLCD_drawChar(unsigned int x, unsigned int y, const unsigned short *c);

extern __inline int isfontchar(unsigned char c)
{
	return ((c >= ' ') && (c < 0x90));
}


/* ASCII Table: codes 32 - 127 and 16 special symbols */
const unsigned short ASCII_Table_1[] =
{
	/* Space ' ' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '!' */
	0x0000, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180,
	0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0000, 0x0000,
	0x0180, 0x0180, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '"' */
	0x0000, 0x0000, 0x00CC, 0x00CC, 0x00CC, 0x00CC, 0x00CC, 0x00CC,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '#' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0C60, 0x0C60,
	0x0C60, 0x0630, 0x0630, 0x1FFE, 0x1FFE, 0x0630, 0x0738, 0x0318,
	0x1FFE, 0x1FFE, 0x0318, 0x0318, 0x018C, 0x018C, 0x018C, 0x0000,
	/* '$' */
	0x0000, 0x0080, 0x03E0, 0x0FF8, 0x0E9C, 0x1C8C, 0x188C, 0x008C,
	0x0098, 0x01F8, 0x07E0, 0x0E80, 0x1C80, 0x188C, 0x188C, 0x189C,
	0x0CB8, 0x0FF0, 0x03E0, 0x0080, 0x0080, 0x0000, 0x0000, 0x0000,
	/* '%' */
	0x0000, 0x0000, 0x0000, 0x180E, 0x0C1B, 0x0C11, 0x0611, 0x0611,
	0x0311, 0x0311, 0x019B, 0x018E, 0x38C0, 0x6CC0, 0x4460, 0x4460,
	0x4430, 0x4430, 0x4418, 0x6C18, 0x380C, 0x0000, 0x0000, 0x0000,
	/* '&' */
	0x0000, 0x01E0, 0x03F0, 0x0738, 0x0618, 0x0618, 0x0330, 0x01F0,
	0x00F0, 0x00F8, 0x319C, 0x330E, 0x1E06, 0x1C06, 0x1C06, 0x3F06,
	0x73FC, 0x21F0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* ''' */
	0x0000, 0x0000, 0x000C, 0x000C, 0x000C, 0x000C, 0x000C, 0x000C,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '(' */
	0x0000, 0x0200, 0x0300, 0x0180, 0x00C0, 0x00C0, 0x0060, 0x0060,
	0x0030, 0x0030, 0x0030, 0x0030, 0x0030, 0x0030, 0x0030, 0x0030,
	0x0060, 0x0060, 0x00C0, 0x00C0, 0x0180, 0x0300, 0x0200, 0x0000,
	/* ')' */
	0x0000, 0x0020, 0x0060, 0x00C0, 0x0180, 0x0180, 0x0300, 0x0300,
	0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x0600,
	0x0300, 0x0300, 0x0180, 0x0180, 0x00C0, 0x0060, 0x0020, 0x0000,
	/* '*' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x00C0, 0x00C0,
	0x06D8, 0x07F8, 0x01E0, 0x0330, 0x0738, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '+' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0180, 0x0180,
	0x0180, 0x0180, 0x0180, 0x3FFC, 0x3FFC, 0x0180, 0x0180, 0x0180,
	0x0180, 0x0180, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* ',' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0180, 0x0180, 0x0100, 0x0100, 0x0080, 0x0000, 0x0000,
	/* '-' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x07E0, 0x07E0, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '.' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x00C0, 0x00C0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '/' */
	0x0000, 0x0C00, 0x0C00, 0x0600, 0x0600, 0x0600, 0x0300, 0x0300,
	0x0300, 0x0380, 0x0180, 0x0180, 0x0180, 0x00C0, 0x00C0, 0x00C0,
	0x0060, 0x0060, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '0' */
	0x0000, 0x03E0, 0x07F0, 0x0E38, 0x0C18, 0x180C, 0x180C, 0x180C,
	0x180C, 0x180C, 0x180C, 0x180C, 0x180C, 0x180C, 0x0C18, 0x0E38,
	0x07F0, 0x03E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '1' */
	0x0000, 0x0100, 0x0180, 0x01C0, 0x01F0, 0x0198, 0x0188, 0x0180,
	0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180,
	0x0180, 0x0180, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '2' */
	0x0000, 0x03E0, 0x0FF8, 0x0C18, 0x180C, 0x180C, 0x1800, 0x1800,
	0x0C00, 0x0600, 0x0300, 0x0180, 0x00C0, 0x0060, 0x0030, 0x0018,
	0x1FFC, 0x1FFC, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '3' */
	0x0000, 0x01E0, 0x07F8, 0x0E18, 0x0C0C, 0x0C0C, 0x0C00, 0x0600,
	0x03C0, 0x07C0, 0x0C00, 0x1800, 0x1800, 0x180C, 0x180C, 0x0C18,
	0x07F8, 0x03E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '4' */
	0x0000, 0x0C00, 0x0E00, 0x0F00, 0x0F00, 0x0D80, 0x0CC0, 0x0C60,
	0x0C60, 0x0C30, 0x0C18, 0x0C0C, 0x3FFC, 0x3FFC, 0x0C00, 0x0C00,
	0x0C00, 0x0C00, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '5' */
	0x0000, 0x0FF8, 0x0FF8, 0x0018, 0x0018, 0x000C, 0x03EC, 0x07FC,
	0x0E1C, 0x1C00, 0x1800, 0x1800, 0x1800, 0x180C, 0x0C1C, 0x0E18,
	0x07F8, 0x03E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '6' */
	0x0000, 0x07C0, 0x0FF0, 0x1C38, 0x1818, 0x0018, 0x000C, 0x03CC,
	0x0FEC, 0x0E3C, 0x1C1C, 0x180C, 0x180C, 0x180C, 0x1C18, 0x0E38,
	0x07F0, 0x03E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '7' */
	0x0000, 0x1FFC, 0x1FFC, 0x0C00, 0x0600, 0x0600, 0x0300, 0x0380,
	0x0180, 0x01C0, 0x00C0, 0x00E0, 0x0060, 0x0060, 0x0070, 0x0030,
	0x0030, 0x0030, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '8' */
	0x0000, 0x03E0, 0x07F0, 0x0E38, 0x0C18, 0x0C18, 0x0C18, 0x0638,
	0x07F0, 0x07F0, 0x0C18, 0x180C, 0x180C, 0x180C, 0x180C, 0x0C38,
	0x0FF8, 0x03E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '9' */
	0x0000, 0x03E0, 0x07F0, 0x0E38, 0x0C1C, 0x180C, 0x180C, 0x180C,
	0x1C1C, 0x1E38, 0x1BF8, 0x19E0, 0x1800, 0x0C00, 0x0C00, 0x0E1C,
	0x07F8, 0x01F0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* ':' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0180, 0x0180,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0180, 0x0180, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* ';' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0180, 0x0180,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0180, 0x0180, 0x0100, 0x0100, 0x0080, 0x0000, 0x0000, 0x0000,
	/* '<' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x1000, 0x1C00, 0x0F80, 0x03E0, 0x00F8, 0x0018, 0x00F8, 0x03E0,
	0x0F80, 0x1C00, 0x1000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '=' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x1FF8, 0x0000, 0x0000, 0x0000, 0x1FF8, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '>' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0008, 0x0038, 0x01F0, 0x07C0, 0x1F00, 0x1800, 0x1F00, 0x07C0,
	0x01F0, 0x0038, 0x0008, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '?' */
	0x0000, 0x03E0, 0x0FF8, 0x0C18, 0x180C, 0x180C, 0x1800, 0x0C00,
	0x0600, 0x0300, 0x0180, 0x00C0, 0x00C0, 0x00C0, 0x0000, 0x0000,
	0x00C0, 0x00C0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '@' */
	0x0000, 0x0000, 0x07E0, 0x1818, 0x2004, 0x29C2, 0x4A22, 0x4411,
	0x4409, 0x4409, 0x4409, 0x2209, 0x1311, 0x0CE2, 0x4002, 0x2004,
	0x1818, 0x07E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'A' */
	0x0000, 0x0380, 0x0380, 0x06C0, 0x06C0, 0x06C0, 0x0C60, 0x0C60,
	0x1830, 0x1830, 0x1830, 0x3FF8, 0x3FF8, 0x701C, 0x600C, 0x600C,
	0xC006, 0xC006, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'B' */
	0x0000, 0x03FC, 0x0FFC, 0x0C0C, 0x180C, 0x180C, 0x180C, 0x0C0C,
	0x07FC, 0x0FFC, 0x180C, 0x300C, 0x300C, 0x300C, 0x300C, 0x180C,
	0x1FFC, 0x07FC, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'C' */
	0x0000, 0x07C0, 0x1FF0, 0x3838, 0x301C, 0x700C, 0x6006, 0x0006,
	0x0006, 0x0006, 0x0006, 0x0006, 0x0006, 0x6006, 0x700C, 0x301C,
	0x1FF0, 0x07E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'D' */
	0x0000, 0x03FE, 0x0FFE, 0x0E06, 0x1806, 0x1806, 0x3006, 0x3006,
	0x3006, 0x3006, 0x3006, 0x3006, 0x3006, 0x1806, 0x1806, 0x0E06,
	0x0FFE, 0x03FE, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'E' */
	0x0000, 0x3FFC, 0x3FFC, 0x000C, 0x000C, 0x000C, 0x000C, 0x000C,
	0x1FFC, 0x1FFC, 0x000C, 0x000C, 0x000C, 0x000C, 0x000C, 0x000C,
	0x3FFC, 0x3FFC, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'F' */
	0x0000, 0x3FF8, 0x3FF8, 0x0018, 0x0018, 0x0018, 0x0018, 0x0018,
	0x1FF8, 0x1FF8, 0x0018, 0x0018, 0x0018, 0x0018, 0x0018, 0x0018,
	0x0018, 0x0018, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'G' */
	0x0000, 0x0FE0, 0x3FF8, 0x783C, 0x600E, 0xE006, 0xC007, 0x0003,
	0x0003, 0xFE03, 0xFE03, 0xC003, 0xC007, 0xC006, 0xC00E, 0xF03C,
	0x3FF8, 0x0FE0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'H' */
	0x0000, 0x300C, 0x300C, 0x300C, 0x300C, 0x300C, 0x300C, 0x300C,
	0x3FFC, 0x3FFC, 0x300C, 0x300C, 0x300C, 0x300C, 0x300C, 0x300C,
	0x300C, 0x300C, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'I' */
	0x0000, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180,
	0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180,
	0x0180, 0x0180, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'J' */
	0x0000, 0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x0600,
	0x0600, 0x0600, 0x0600, 0x0600, 0x0600, 0x0618, 0x0618, 0x0738,
	0x03F0, 0x01E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'K' */
	0x0000, 0x3006, 0x1806, 0x0C06, 0x0606, 0x0306, 0x0186, 0x00C6,
	0x0066, 0x0076, 0x00DE, 0x018E, 0x0306, 0x0606, 0x0C06, 0x1806,
	0x3006, 0x6006, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'L' */
	0x0000, 0x0018, 0x0018, 0x0018, 0x0018, 0x0018, 0x0018, 0x0018,
	0x0018, 0x0018, 0x0018, 0x0018, 0x0018, 0x0018, 0x0018, 0x0018,
	0x1FF8, 0x1FF8, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'M' */
	0x0000, 0xE00E, 0xF01E, 0xF01E, 0xF01E, 0xD836, 0xD836, 0xD836,
	0xD836, 0xCC66, 0xCC66, 0xCC66, 0xC6C6, 0xC6C6, 0xC6C6, 0xC6C6,
	0xC386, 0xC386, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'N' */
	0x0000, 0x300C, 0x301C, 0x303C, 0x303C, 0x306C, 0x306C, 0x30CC,
	0x30CC, 0x318C, 0x330C, 0x330C, 0x360C, 0x360C, 0x3C0C, 0x3C0C,
	0x380C, 0x300C, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'O' */
	0x0000, 0x07E0, 0x1FF8, 0x381C, 0x700E, 0x6006, 0xC003, 0xC003,
	0xC003, 0xC003, 0xC003, 0xC003, 0xC003, 0x6006, 0x700E, 0x381C,
	0x1FF8, 0x07E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'P' */
	0x0000, 0x0FFC, 0x1FFC, 0x380C, 0x300C, 0x300C, 0x300C, 0x300C,
	0x180C, 0x1FFC, 0x07FC, 0x000C, 0x000C, 0x000C, 0x000C, 0x000C,
	0x000C, 0x000C, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'Q' */
	0x0000, 0x07E0, 0x1FF8, 0x381C, 0x700E, 0x6006, 0xE003, 0xC003,
	0xC003, 0xC003, 0xC003, 0xC003, 0xE007, 0x6306, 0x3F0E, 0x3C1C,
	0x3FF8, 0xF7E0, 0xC000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'R' */
	0x0000, 0x0FFE, 0x1FFE, 0x3806, 0x3006, 0x3006, 0x3006, 0x3806,
	0x1FFE, 0x07FE, 0x0306, 0x0606, 0x0C06, 0x1806, 0x1806, 0x3006,
	0x3006, 0x6006, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'S' */
	0x0000, 0x03E0, 0x0FF8, 0x0C1C, 0x180C, 0x180C, 0x000C, 0x001C,
	0x03F8, 0x0FE0, 0x1E00, 0x3800, 0x3006, 0x3006, 0x300E, 0x1C1C,
	0x0FF8, 0x07E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'T' */
	0x0000, 0x7FFE, 0x7FFE, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180,
	0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180,
	0x0180, 0x0180, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'U' */
	0x0000, 0x300C, 0x300C, 0x300C, 0x300C, 0x300C, 0x300C, 0x300C,
	0x300C, 0x300C, 0x300C, 0x300C, 0x300C, 0x300C, 0x300C, 0x1818,
	0x1FF8, 0x07E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'V' */
	0x0000, 0x6003, 0x3006, 0x3006, 0x3006, 0x180C, 0x180C, 0x180C,
	0x0C18, 0x0C18, 0x0E38, 0x0630, 0x0630, 0x0770, 0x0360, 0x0360,
	0x01C0, 0x01C0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'W' */
	0x0000, 0x6003, 0x61C3, 0x61C3, 0x61C3, 0x3366, 0x3366, 0x3366,
	0x3366, 0x3366, 0x3366, 0x1B6C, 0x1B6C, 0x1B6C, 0x1A2C, 0x1E3C,
	0x0E38, 0x0E38, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'X' */
	0x0000, 0xE00F, 0x700C, 0x3018, 0x1830, 0x0C70, 0x0E60, 0x07C0,
	0x0380, 0x0380, 0x03C0, 0x06E0, 0x0C70, 0x1C30, 0x1818, 0x300C,
	0x600E, 0xE007, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'Y' */
	0x0000, 0xC003, 0x6006, 0x300C, 0x381C, 0x1838, 0x0C30, 0x0660,
	0x07E0, 0x03C0, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180,
	0x0180, 0x0180, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'Z' */
	0x0000, 0x7FFC, 0x7FFC, 0x6000, 0x3000, 0x1800, 0x0C00, 0x0600,
	0x0300, 0x0180, 0x00C0, 0x0060, 0x0030, 0x0018, 0x000C, 0x0006,
	0x7FFE, 0x7FFE, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '[' */
	0x0000, 0x03E0, 0x03E0, 0x0060, 0x0060, 0x0060, 0x0060, 0x0060,
	0x0060, 0x0060, 0x0060, 0x0060, 0x0060, 0x0060, 0x0060, 0x0060,
	0x0060, 0x0060, 0x0060, 0x0060, 0x0060, 0x03E0, 0x03E0, 0x0000,
	/* '\' */
	0x0000, 0x0030, 0x0030, 0x0060, 0x0060, 0x0060, 0x00C0, 0x00C0,
	0x00C0, 0x01C0, 0x0180, 0x0180, 0x0180, 0x0300, 0x0300, 0x0300,
	0x0600, 0x0600, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* ']' */
	0x0000, 0x03E0, 0x03E0, 0x0300, 0x0300, 0x0300, 0x0300, 0x0300,
	0x0300, 0x0300, 0x0300, 0x0300, 0x0300, 0x0300, 0x0300, 0x0300,
	0x0300, 0x0300, 0x0300, 0x0300, 0x0300, 0x03E0, 0x03E0, 0x0000,
	/* '^' */
	0x0000, 0x0000, 0x01C0, 0x01C0, 0x0360, 0x0360, 0x0360, 0x0630,
	0x0630, 0x0C18, 0x0C18, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '_' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* ''' */
	0x0000, 0x000C, 0x000C, 0x000C, 0x000C, 0x000C, 0x000C, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'a' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x03F0, 0x07F8,
	0x0C1C, 0x0C0C, 0x0F00, 0x0FF0, 0x0CF8, 0x0C0C, 0x0C0C, 0x0F1C,
	0x0FF8, 0x18F0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'b' */
	0x0000, 0x0018, 0x0018, 0x0018, 0x0018, 0x0018, 0x03D8, 0x0FF8,
	0x0C38, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x0C38,
	0x0FF8, 0x03D8, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'c' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x03C0, 0x07F0,
	0x0E30, 0x0C18, 0x0018, 0x0018, 0x0018, 0x0018, 0x0C18, 0x0E30,
	0x07F0, 0x03C0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'd' */
	0x0000, 0x1800, 0x1800, 0x1800, 0x1800, 0x1800, 0x1BC0, 0x1FF0,
	0x1C30, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1C30,
	0x1FF0, 0x1BC0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'e' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x03C0, 0x0FF0,
	0x0C30, 0x1818, 0x1FF8, 0x1FF8, 0x0018, 0x0018, 0x1838, 0x1C30,
	0x0FF0, 0x07C0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'f' */
	0x0000, 0x0F80, 0x0FC0, 0x00C0, 0x00C0, 0x00C0, 0x07F0, 0x07F0,
	0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0,
	0x00C0, 0x00C0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'g' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0DE0, 0x0FF8,
	0x0E18, 0x0C0C, 0x0C0C, 0x0C0C, 0x0C0C, 0x0C0C, 0x0C0C, 0x0E18,
	0x0FF8, 0x0DE0, 0x0C00, 0x0C0C, 0x061C, 0x07F8, 0x01F0, 0x0000,
	/* 'h' */
	0x0000, 0x0018, 0x0018, 0x0018, 0x0018, 0x0018, 0x07D8, 0x0FF8,
	0x1C38, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818,
	0x1818, 0x1818, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'i' */
	0x0000, 0x00C0, 0x00C0, 0x0000, 0x0000, 0x0000, 0x00C0, 0x00C0,
	0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0,
	0x00C0, 0x00C0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'j' */
	0x0000, 0x00C0, 0x00C0, 0x0000, 0x0000, 0x0000, 0x00C0, 0x00C0,
	0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0,
	0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00F8, 0x0078, 0x0000,
	/* 'k' */
	0x0000, 0x000C, 0x000C, 0x000C, 0x000C, 0x000C, 0x0C0C, 0x060C,
	0x030C, 0x018C, 0x00CC, 0x006C, 0x00FC, 0x019C, 0x038C, 0x030C,
	0x060C, 0x0C0C, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'l' */
	0x0000, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0,
	0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0,
	0x00C0, 0x00C0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'm' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3C7C, 0x7EFF,
	0xE3C7, 0xC183, 0xC183, 0xC183, 0xC183, 0xC183, 0xC183, 0xC183,
	0xC183, 0xC183, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'n' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0798, 0x0FF8,
	0x1C38, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818,
	0x1818, 0x1818, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'o' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x03C0, 0x0FF0,
	0x0C30, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x0C30,
	0x0FF0, 0x03C0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'p' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x03D8, 0x0FF8,
	0x0C38, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x0C38,
	0x0FF8, 0x03D8, 0x0018, 0x0018, 0x0018, 0x0018, 0x0018, 0x0000,
	/* 'q' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1BC0, 0x1FF0,
	0x1C30, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1C30,
	0x1FF0, 0x1BC0, 0x1800, 0x1800, 0x1800, 0x1800, 0x1800, 0x0000,
	/* 'r' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x07B0, 0x03F0,
	0x0070, 0x0030, 0x0030, 0x0030, 0x0030, 0x0030, 0x0030, 0x0030,
	0x0030, 0x0030, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 's' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x03E0, 0x03F0,
	0x0E38, 0x0C18, 0x0038, 0x03F0, 0x07C0, 0x0C00, 0x0C18, 0x0E38,
	0x07F0, 0x03E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 't' */
	0x0000, 0x0000, 0x0080, 0x00C0, 0x00C0, 0x00C0, 0x07F0, 0x07F0,
	0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0,
	0x07C0, 0x0780, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'u' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1818, 0x1818,
	0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1C38,
	0x1FF0, 0x19E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'v' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x180C, 0x0C18,
	0x0C18, 0x0C18, 0x0630, 0x0630, 0x0630, 0x0360, 0x0360, 0x0360,
	0x01C0, 0x01C0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'w' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x41C1, 0x41C1,
	0x61C3, 0x6363, 0x6363, 0x6363, 0x3636, 0x3636, 0x3636, 0x1C1C,
	0x1C1C, 0x1C1C, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'x' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x381C, 0x1C38,
	0x0C30, 0x0660, 0x0360, 0x0360, 0x0360, 0x0360, 0x0660, 0x0C30,
	0x1C38, 0x381C, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* 'y' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x3018, 0x1830,
	0x1830, 0x1870, 0x0C60, 0x0C60, 0x0CE0, 0x06C0, 0x06C0, 0x0380,
	0x0380, 0x0380, 0x0180, 0x0180, 0x01C0, 0x00F0, 0x0070, 0x0000,
	/* 'z' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x1FFC, 0x1FFC,
	0x0C00, 0x0600, 0x0300, 0x0180, 0x00C0, 0x0060, 0x0030, 0x0018,
	0x1FFC, 0x1FFC, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* '{' */
	0x0000, 0x0300, 0x0180, 0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x00C0,
	0x00C0, 0x0060, 0x0060, 0x0030, 0x0060, 0x0040, 0x00C0, 0x00C0,
	0x00C0, 0x00C0, 0x00C0, 0x00C0, 0x0180, 0x0300, 0x0000, 0x0000,
	/* '|' */
	0x0000, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180,
	0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180,
	0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0180, 0x0000,
	/* '}' */
	0x0000, 0x0060, 0x00C0, 0x01C0, 0x0180, 0x0180, 0x0180, 0x0180,
	0x0180, 0x0300, 0x0300, 0x0600, 0x0300, 0x0100, 0x0180, 0x0180,
	0x0180, 0x0180, 0x0180, 0x0180, 0x00C0, 0x0060, 0x0000, 0x0000,
	/* '~' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x10F0, 0x1FF8, 0x0F08, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* ' ' */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,

	/* Special Symbols  starting at character 0x80 */
	/* Circle - Empty */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x03C0, 0x0C30, 0x1008,
	0x2004, 0x2004, 0x4002, 0x4002, 0x4002, 0x4002, 0x4002, 0x2004,
	0x2004, 0x1008, 0x0C30, 0x03C0, 0x0000, 0x0000, 0x0000, 0x0000,
	/* Circle - Full */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x03C0, 0x0FF0, 0x1FF8,
	0x3FFC, 0x3FFC, 0x7FFE, 0x7FFE, 0x7FFE, 0x7FFE, 0x7FFE, 0x3FFC,
	0x3FFC, 0x1FF8, 0x0FF0, 0x03C0, 0x0000, 0x0000, 0x0000, 0x0000,
	/* Square - Empty */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x07E0,
	0x0FF0, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x1818, 0x0FF0,
	0x07E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* Square - Full */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x07E0,
	0x0FF0, 0x1FF8, 0x1FF8, 0x1FF8, 0x1FF8, 0x1FF8, 0x1FF8, 0x0FF0,
	0x07E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* Up - Empty */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0180, 0x03C0, 0x0660, 0x0C30,
	0x1818, 0x1818, 0x1FF8, 0x1FF8, 0x0000, 0x0000, 0x0000, 0x0000,
	/* Up - Full */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0180, 0x03C0, 0x07E0, 0x0FF0,
	0x1FF8, 0x1FF8, 0x1FF8, 0x1FF8, 0x0000, 0x0000, 0x0000, 0x0000,
	/* Down - Empty */
	0x0000, 0x0000, 0x0000, 0x0000, 0x1FF8, 0x1FF8, 0x1818, 0x1818,
	0x0C30, 0x0660, 0x03C0, 0x0180, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* Down - Full */
	0x0000, 0x0000, 0x0000, 0x0000, 0x1FF8, 0x1FF8, 0x1FF8, 0x1FF8,
	0x0FF0, 0x07E0, 0x03C0, 0x0180, 0x0000, 0x0000, 0x0000, 0x0000,
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* Left - Empty */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x01E0,
	0x01F0, 0x0198, 0x018C, 0x0186, 0x0186, 0x018C, 0x0198, 0x01F0,
	0x01E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* Left - Full */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x01E0,
	0x01F0, 0x01F8, 0x01FC, 0x01FE, 0x01FE, 0x01FC, 0x01F8, 0x01F0,
	0x01E0, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* Right - Empty */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0780,
	0x0F80, 0x1980, 0x3180, 0x6180, 0x6180, 0x3180, 0x1980, 0x0F80,
	0x0780, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* Right - Full */
	0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0780,
	0x0F80, 0x1F80, 0x3F80, 0x7F80, 0x7F80, 0x3F80, 0x1F80, 0x0F80,
	0x0780, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
	/* Wait - Empty */
	0x0000, 0x01C0, 0x0220, 0x0220, 0x0140, 0x0630, 0x0808, 0x0808,
	0x0808, 0x0808, 0x0808, 0x0808, 0x0808, 0x0220, 0x0220, 0x0220,
	0x0220, 0x0220, 0x0220, 0x0220, 0x0220, 0x0220, 0x0220, 0x0000,
	/* Wait - Full */
	0x0000, 0x01C0, 0x03E0, 0x03E0, 0x01C0, 0x07F0, 0x0DD8, 0x0DD8,
	0x0DD8, 0x0DD8, 0x0DD8, 0x0DD8, 0x0DD8, 0x0360, 0x0360, 0x0360,
	0x0360, 0x0360, 0x0360, 0x0360, 0x0360, 0x0360, 0x0360, 0x0000,
	/* Walk - Empty */
	0x0000, 0x01C0, 0x0220, 0x0220, 0x0140, 0x0630, 0x0808, 0x0808,
	0x0808, 0x1004, 0x2002, 0x2002, 0x0140, 0x0220, 0x0220, 0x0410,
	0x0808, 0x0808, 0x1004, 0x1004, 0x2004, 0x4004, 0x0000, 0x0000,
	/* Walk - Full */
	0x0000, 0x01C0, 0x03E0, 0x03E0, 0x01C0, 0x07F0, 0x0DD8, 0x0DD8,
	0x0DD8, 0x19CC, 0x31C6, 0x61C2, 0x01C0, 0x0360, 0x0360, 0x0670,
	0x0C38, 0x0C18, 0x180C, 0x180C, 0x300C, 0x600C, 0x0000, 0x0000,
};

void qspi0_init()
{
	//uint16 password = IfxScuWdt_getCpuWatchdogPassword();
	//IfxScuWdt_clearSafetyEndinit(password);
	//IfxScuWdt_clearSafetyEndinitInline (IfxScuWdt_getSafetyWatchdogPasswordInline ());
	unlock_wdtcon();				/* remove ENDINIT protection */
	QSPI0_CLC.U = 0x0;				/* activate module */
	(void)QSPI0_CLC.U;				/* read back to get effective */
	P20_PDR0.U = 0x00000000;		/* fast speed (all pins) */
	P20_PDR1.U = 0x00080000;		/* MRST0 at TTL level */
	//IfxScuWdt_setSafetyEndinit(password);
	//IfxScuWdt_setSafetyEndinitInline (IfxScuWdt_getSafetyWatchdogPasswordInline ());
	lock_wdtcon ();

	/* configure port pins */
	P20_IOCR0.B.PC3 = 0x13;			/* SLSO09 (touch) */
	P20_IOCR4.B.PC6 = 0x13;			/* SLSO08 (LCD) */

	P20_IOCR8.B.PC11 = 0x13;		/* SCLK0 */
	P20_IOCR12.B.PC14 = 0x13;		/* MTSR0 */

	QSPI0_GLOBALCON.U	= (15 << IFX_QSPI_GLOBALCON_EXPECT_OFF)
						| (1 << IFX_QSPI_GLOBALCON_SI_OFF);

	QSPI0_GLOBALCON1.U	= (4 << IFX_QSPI_GLOBALCON1_PT1_OFF)
						| (1 << IFX_QSPI_GLOBALCON1_USREN_OFF)
						| (1 << IFX_QSPI_GLOBALCON1_PT2EN_OFF)
						| (1 << IFX_QSPI_GLOBALCON1_PT1EN_OFF)
						| (1 << IFX_QSPI_GLOBALCON1_RXEN_OFF)
						| (1 << IFX_QSPI_GLOBALCON1_TXEN_OFF)
						| (0x7F << IFX_QSPI_GLOBALCON1_ERRORENS_OFF);
	/* enable SLSO08+SLSO09, low active */
	QSPI0_SSOC.U = ((3 << 8) << IFX_QSPI_SSOC_OEN_OFF);
#if 0
	QSPI0_ECON0.U = (0 << IFX_QSPI_ECON_C_OFF)
#else
	/* without this polarity selected reading from TFT does not work correctly */
	QSPI0_ECON0.U = (1 << IFX_QSPI_ECON_CPOL_OFF)
				  | (0 << IFX_QSPI_ECON_C_OFF)
#endif
				  | (2 << IFX_QSPI_ECON_B_OFF)
				  | ((2 - 1) << IFX_QSPI_ECON_A_OFF)
				  | ((1 - 1) << IFX_QSPI_ECON_Q_OFF);
	/* Touch: 2 MHz ==> 500ns SCLK: Q=25,A=2,B=1,C=1 */
	QSPI0_ECON1.U = (1 << IFX_QSPI_ECON_C_OFF)
				  | (1 << IFX_QSPI_ECON_B_OFF)
				  | ((2 - 1) << IFX_QSPI_ECON_A_OFF)
				  | ((25 - 1) << IFX_QSPI_ECON_Q_OFF);
	/* used to release endless mode of LCD */
	/* 50 MHz ==> 20ns SCLK: Q=1,A=2,B=1,C=1 */
	QSPI0_ECON7.U = (1 << IFX_QSPI_ECON_C_OFF)
				  | (1 << IFX_QSPI_ECON_B_OFF)
				  | ((2 - 1) << IFX_QSPI_ECON_A_OFF)
				  | ((1 - 1) << IFX_QSPI_ECON_Q_OFF);
	QSPI0_GLOBALCON.B.EN = 1;		/* ... and enable the module */
}

/*******************************************************************************
* Clear display                                                                *
*   Parameter:    color:  color for clearing display                           *
*   Return:                                                                    *
*******************************************************************************/
void GLCD_clear(unsigned short color)
{
	unsigned int	i;

	glcd_set_position(0, 0);
	glcd_start_GRAM_write();
	for (i = 0; i < (WIDTH*HEIGHT); ++i)
	{
		wr_dat_endless(color);
	}
	wr_end_transfer();
}

static void glcd_set_position(unsigned int x, unsigned int y)
{
	if (ID_ILI9341 == DriverCode)
	{
		wr_cmd_endless(0x2B);	/* Page Address Set: only start is set */
		wr_dat_endless(x >> 8);
		wr_dat_endless(x);
		wr_end_transfer();
		wr_cmd_endless(0x2A);	/* Column Address Set: only start is set */
		wr_dat_endless(y >> 8);
		wr_dat_endless(y);
		wr_end_transfer();
	}
	else
	{
		wr_reg(0x20, x);
		wr_reg(0x21, y);
	}
}

static void glcd_start_GRAM_write(void)
{
	if (ID_ILI9341 == DriverCode)
	{
		wr_cmd_endless(0x2C);	/* Memory Write */
	}
	else
	{
		wr_cmd_endless(0x22);
	}
}

/* write command to LCD and start an endless transfer */
static void wr_cmd_endless(unsigned int cmd)
{
	/* we need 3 free entries */
	while (QSPI0_STATUS.B.TXFIFOLEVEL > (4 - 3))
		;
	QSPI0_BACONENTRY.U	= (CS_CPLD << IFX_QSPI_BACON_CS_OFF)
						| (IFX_QSPI_BACON_MSB_MSK << IFX_QSPI_BACON_MSB_OFF)
						| ((10-1) << IFX_QSPI_BACON_DL_OFF)
						| (1 << IFX_QSPI_BACON_LEAD_OFF);
	/* start an endless transfer */
	QSPI0_DATAENTRY0.U	= (1 << 8) | cmd;
	/* configure size for endless data transfer */
	QSPI0_MIXENTRY.U	= (CS_CPLD << IFX_QSPI_BACON_CS_OFF)
						| (IFX_QSPI_BACON_MSB_MSK << IFX_QSPI_BACON_MSB_OFF)
						| ((16-1) << IFX_QSPI_BACON_DL_OFF)
						| (1 << IFX_QSPI_BACON_LEAD_OFF);
}

/* write data to LCD in endless transfer mode */
static void wr_dat_endless(unsigned int c)
{
	/* we need 1 free entry */
	while (QSPI0_STATUS.B.TXFIFOLEVEL > (4 - 1))
		;
	QSPI0_MIXENTRY.U = c;
}


/* terminate an endless data transfer to|from LCD */
static void wr_end_transfer(void)
{
	/* we need 4 free entries */
	while (QSPI0_STATUS.B.TXFIFOLEVEL > (4 - 4))
		;
	QSPI0_BACONENTRY.U	= (CS_CPLD << IFX_QSPI_BACON_CS_OFF)
						| (IFX_QSPI_BACON_MSB_MSK << IFX_QSPI_BACON_MSB_OFF)
						| ((16-1) << IFX_QSPI_BACON_DL_OFF)
						| (1 << IFX_QSPI_BACON_LEAD_OFF)
						| (IFX_QSPI_BACON_LAST_MSK << IFX_QSPI_BACON_LAST_OFF);
	QSPI0_DATAENTRY0.U	= 0;
	/* switch to dummy chip select */
	QSPI0_BACONENTRY.U	= (CS_NONE << IFX_QSPI_BACON_CS_OFF)
						| (IFX_QSPI_BACON_MSB_MSK << IFX_QSPI_BACON_MSB_OFF)
						| ((9-1) << IFX_QSPI_BACON_DL_OFF)
						| (1 << IFX_QSPI_BACON_LEAD_OFF)
						| (IFX_QSPI_BACON_LAST_MSK << IFX_QSPI_BACON_LAST_OFF);
	QSPI0_DATAENTRY0.U	= 0;

	/* wait until all data received */
	while (QSPI0_STATUS.B.RXFIFOLEVEL != 4)
		;

	/* ... and read and discard the data */
	(void)QSPI0_RXEXIT.U;
	(void)QSPI0_RXEXIT.U;
	(void)QSPI0_RXEXIT.U;
	(void)QSPI0_RXEXIT.U;
}

/* write LCD register <reg> with <value> */
static void wr_reg(unsigned int reg, unsigned int val)
{
	/* we need 2 free entries */
	while (QSPI0_STATUS.B.TXFIFOLEVEL > (4 - 2))
		;
	QSPI0_BACONENTRY.U	= (CS_CPLD << IFX_QSPI_BACON_CS_OFF)
						| (IFX_QSPI_BACON_MSB_MSK << IFX_QSPI_BACON_MSB_OFF)
						| ((32-1) << IFX_QSPI_BACON_DL_OFF)
						| (1 << IFX_QSPI_BACON_LEAD_OFF)
						| (IFX_QSPI_BACON_LAST_MSK << IFX_QSPI_BACON_LAST_OFF);
	QSPI0_DATAENTRY0.U	= (reg << 22) | (val << 6);
}


void GLCD_init(void)
{
	/* prepare LCD background light pin */
	BGL_INIT();

	/* initialise QSPI0 interface */
	qspi0_init();

	IfxStm_waitTicks(stm0, IfxStm_getTicksFromMilliseconds(stm0, 50));		/* Delay 50 ms */

	/* read driver code */
	DriverCode = get_id_code();

	if (ID_ILI9341 == DriverCode)
	{
		/************* Start Initial Sequence **********/
		wr_cmd_endless(0xCF);
		wr_dat_endless(0x00);
		wr_dat_endless(0x83);
		wr_dat_endless(0x30);
		wr_end_transfer();

		wr_cmd_endless(0xED);
		wr_dat_endless(0x64);
		wr_dat_endless(0x03);
		wr_dat_endless(0x12);
		wr_dat_endless(0x81);
		wr_end_transfer();

		wr_cmd_endless(0xE8);
		wr_dat_endless(0x85);
		wr_dat_endless(0x00);
		wr_dat_endless(0x78);
		wr_end_transfer();

		wr_cmd_endless(0xCB);
		wr_dat_endless(0x39);
		wr_dat_endless(0x2C);
		wr_dat_endless(0x00);
		wr_dat_endless(0x34);
		wr_dat_endless(0x02);
		wr_end_transfer();

		wr_cmd_endless(0xF7);
		wr_dat_endless(0x20);
		wr_end_transfer();

		wr_cmd_endless(0xEA);
		wr_dat_endless(0x00);
		wr_dat_endless(0x00);
		wr_end_transfer();

		wr_cmd_endless(0xC0);	/* Power Control 1 */
		wr_dat_endless(0x19);	/* VRH[5:0] */
		wr_end_transfer();

		wr_cmd_endless(0xC1);	/* Power Control 2 */
		wr_dat_endless(0x11);	/* BT[2:0] */
		wr_end_transfer();

		wr_cmd_endless(0xC5);	/* VCOM Control 1 */
		wr_dat_endless(0x3C);	/* VMH[6:0] */
		wr_dat_endless(0x3F);	/* VML[6:0] */
		wr_end_transfer();

		wr_cmd_endless(0xC7);	/* VCOM Control 2 */
		wr_dat_endless(0x90);	/* VMF[6:0] */
		wr_end_transfer();

		wr_cmd_endless(0x36);	/* Memory Access Control */
		wr_dat_endless(0x28);	/* MV=1; BGR=1 */
		wr_end_transfer();

		wr_cmd_endless(0x3A);	/* Pixel Format Set */
		wr_dat_endless(0x55);	/* DPI[2:0]=5; DBI[2:0]=5 (16 bit) */
		wr_end_transfer();

		wr_cmd_endless(0xB1);	/* Frame Control (normal mode) */
		wr_dat_endless(0x00);	/* DIVA[1:0] */
		wr_dat_endless(0x17);	/* RTNA[4:0] */
		wr_end_transfer();

		wr_cmd_endless(0xB6);	/* Display Function Control */
		wr_dat_endless(0x0A);	/* PTG[1:0]=2;PT[1:0]=2 */
		wr_dat_endless(0xA2);	/* REV=1,GS=0,SS=1,SM=0,ISC[3:0]=2 */
		wr_end_transfer();

		wr_cmd_endless(0xF6);	/* Interface Control */
		wr_dat_endless(0x01);	/* WEMODE=1 */
		wr_dat_endless(0x30);	/* EPF[1:0]=3; MDT[1:0]=0 */
		wr_end_transfer();

		wr_cmd_endless(0xF2);	/* Gamma Function Disable (??) */
		wr_dat_endless(0x00);
		wr_end_transfer();

		wr_cmd_endless(0x26);	/* Gamma Set */
		wr_dat_endless(0x01);	/* GC[7:0] */
		wr_end_transfer();

		wr_cmd_endless(0xE0);	/* Positive Gamma Correction */
		wr_dat_endless(0x0F);
		wr_dat_endless(0x26);
		wr_dat_endless(0x22);
		wr_dat_endless(0x0A);
		wr_dat_endless(0x10);
		wr_dat_endless(0x0A);
		wr_dat_endless(0x4C);
		wr_dat_endless(0xCA);
		wr_dat_endless(0x36);
		wr_dat_endless(0x00);
		wr_dat_endless(0x15);
		wr_dat_endless(0x00);
		wr_dat_endless(0x10);
		wr_dat_endless(0x10);
		wr_dat_endless(0x00);
		wr_end_transfer();

		wr_cmd_endless(0xE1);	/* Negative Gamma Correction */
		wr_dat_endless(0x00);
		wr_dat_endless(0x19);
		wr_dat_endless(0x1B);
		wr_dat_endless(0x05);
		wr_dat_endless(0x0F);
		wr_dat_endless(0x05);
		wr_dat_endless(0x33);
		wr_dat_endless(0x35);
		wr_dat_endless(0x49);
		wr_dat_endless(0x0F);
		wr_dat_endless(0x1F);
		wr_dat_endless(0x0F);
		wr_dat_endless(0x3F);
		wr_dat_endless(0x3F);
		wr_dat_endless(0x0F);
		wr_end_transfer();

		/* set graphic window dimensions */
		glcd_set_graph_window(0, (HEIGHT-1), 0, (WIDTH-1));

		wr_cmd_endless(0x11);	/* Exit Sleep */
		wr_end_transfer();

		IfxStm_waitTicks(stm0, IfxStm_getTicksFromMilliseconds(stm0, 120));			/* Delay 120 ms */

		wr_cmd_endless(0x29);	/* Displa ON */
		wr_end_transfer();
	}
	else if ((ID_ILI9320 == DriverCode) || (ID_ILI9325 == DriverCode))
	{
		/* Start Initial Sequence ------------------------------------------------*/
		wr_reg(0x00, 0x0001);				/* Start internal OSC                 */
		wr_reg(0x01, 0x0100);				/* Set SS bit                         */
		wr_reg(0x02, 0x0700);				/* Set 1 line inversion               */
		wr_reg(0x03, 0x1028);				/* Set GRAM write direction and BGR=1 */
		wr_reg(0x04, 0x0000);				/* Resize register                    */
		wr_reg(0x08, 0x0202);				/* 2 lines each, back and front porch */
		wr_reg(0x09, 0x0000);				/* Set non-disp area refresh cyc ISC  */
		wr_reg(0x0A, 0x0000);				/* FMARK function                     */
		wr_reg(0x0C, 0x0000);				/* RGB interface setting              */
		wr_reg(0x0D, 0x0000);				/* Frame marker Position              */
		wr_reg(0x0F, 0x0000);				/* RGB interface polarity             */

		/* Power On sequence -----------------------------------------------------*/
		wr_reg(0x10, 0x0000);				/* Reset Power Control 1              */
		wr_reg(0x11, 0x0000);				/* Reset Power Control 2              */
		wr_reg(0x12, 0x0000);				/* Reset Power Control 3              */
		wr_reg(0x13, 0x0000);				/* Reset Power Control 4              */
		IfxStm_waitTicks(stm0, IfxStm_getTicksFromMilliseconds(stm0, 200));			/* Delay 120 ms */							/* Discharge cap power voltage (200ms)*/
		wr_reg(0x10, 0x0080);				/* SAP, BT[3:0], AP, DSTB, SLP, STB   */
		wr_reg(0x11, 0x0007);				/* DC1[2:0], DC0[2:0], VC[2:0]        */
		IfxStm_waitTicks(stm0, IfxStm_getTicksFromMilliseconds(stm0, 50));							/* Delay 50 ms                        */
		wr_reg(0x10, 0x1290);				/* SAP, BT[3:0], AP, DSTB, SLP, STB   */
		wr_reg(0x11, 0x0227);				/* DC1[2:0], DC0[2:0], VC[2:0]        */
		wr_reg(0x12, 0x001C);				/* VREG1OUT voltage                   */
		IfxStm_waitTicks(stm0, IfxStm_getTicksFromMilliseconds(stm0, 50));							/* Delay 50 ms                        */
		wr_reg(0x13, 0x1600);				/* VDV[4:0] for VCOM amplitude        */
		wr_reg(0x29, 0x0012);				/* VCM[4:0] for VCOMH                 */
		wr_reg(0x2B, 0x000D);				/* Set Frame Rate  (128 Hz)           */
		IfxStm_waitTicks(stm0, IfxStm_getTicksFromMilliseconds(stm0, 120));							/* Delay 50 ms                        */
		wr_reg(0x20, 0x0000);				/* GRAM horizontal Address            */
		wr_reg(0x21, 0x0000);				/* GRAM Vertical Address              */

		/* Adjust the Gamma Curve ------------------------------------------------*/
		wr_reg(0x30, 0x0007);
		wr_reg(0x31, 0x0707);
		wr_reg(0x32, 0x0107);
		wr_reg(0x35, 0x0206);
		wr_reg(0x36, 0x0408);
		wr_reg(0x37, 0x0006);
		wr_reg(0x38, 0x0000);
		wr_reg(0x39, 0x0207);
		wr_reg(0x3C, 0x0504);
		wr_reg(0x3D, 0x1501);

		/* Set GRAM area ---------------------------------------------------------*/
		wr_reg(0x50, 0x0000);				/* Horizontal GRAM Start Address      */
		wr_reg(0x51, (HEIGHT-1));			/* Horizontal GRAM End   Address      */
		wr_reg(0x52, 0x0000);				/* Vertical   GRAM Start Address      */
		wr_reg(0x53, (WIDTH-1));			/* Vertical   GRAM End   Address      */
		wr_reg(0x60, 0xA700);				/* Gate Scan Line (GS=1)              */
		wr_reg(0x61, 0x0001);				/* NDL,VLE, REV                       */
		wr_reg(0x6A, 0x0000);				/* Set scrolling line                 */

		/* Partial Display Control -----------------------------------------------*/
		wr_reg(0x80, 0x0000);
		wr_reg(0x81, 0x0000);
		wr_reg(0x82, 0x0000);
		wr_reg(0x83, 0x0000);
		wr_reg(0x84, 0x0000);
		wr_reg(0x85, 0x0000);

		/* Panel Control ---------------------------------------------------------*/
		wr_reg(0x90, 0x0010);
		wr_reg(0x92, 0x0000);
		wr_reg(0x93, 0x0003);
		wr_reg(0x95, 0x0110);
		wr_reg(0x97, 0x0000);
		wr_reg(0x98, 0x0000);

		/* Set GRAM write direction and BGR = 1
		   I/D=11 (Horizontal : increment, Vertical : increment)
		   AM=1 (address is updated in vertical writing direction)
		 */
		wr_reg(0x03, 0x1038);

		wr_reg(0x07, 0x0133);	/* 262K color and display ON */
	}

	/* Turn backlight on */
	BGL_ON();
}
/* read ID code of LCD controller */
static unsigned short get_id_code(void)
{
	/* start with reg 0 (returns ID for ILI932x) */
	unsigned short id = rd_reg(0x00);

	if (0 == id)
	{
		/* try special test for ILI9341 */
		unsigned short temp;
		/* Read ID4 register: first byte returned is ignored */
		(void)rd_reg_endless(0xD3);
		temp = rd_dat_endless();
		if (0 == temp)
		{
			temp = rd_dat_endless();
			id = (temp & 0xFF) << 8;
			temp = rd_dat_endless();
			id |= (temp & 0xFF);
		}
		/* finish endless transfer mode */
		wr_end_transfer();
	}

	return id;
}

/* read from LCD register <reg> */
static unsigned short rd_reg(unsigned int reg)
{
	unsigned int data;

	/* remove any old stuff from RXFIFO */
	/* read RXFIFO until empty */
	while (QSPI0_STATUS.B.RXFIFOLEVEL != 0)
	{
		(void)QSPI0_RXEXIT.U;
	}
	/* check for RXFIFO overflow and clear this error */
	data = QSPI0_STATUS.B.ERRORFLAGS & QSPI_ERROR_RXOVF;
	if (data)
	{
		QSPI0_FLAGSCLEAR.U = data;
	}

	/* we need 4 free entries */
	while (QSPI0_STATUS.B.TXFIFOLEVEL > (4 - 4))
		;
	/* we need 16 bit for setting the register */
	QSPI0_BACONENTRY.U	= (CS_CPLD << IFX_QSPI_BACON_CS_OFF)
						| (IFX_QSPI_BACON_MSB_MSK << IFX_QSPI_BACON_MSB_OFF)
						| ((16-1) << IFX_QSPI_BACON_DL_OFF)
						| (1 << IFX_QSPI_BACON_LEAD_OFF);
	/* mark as read register */
	QSPI0_DATAENTRY0.U	= ((1 << 9) | reg) << 6;
	/* we need 26 clocks for reading the data */
	QSPI0_BACONENTRY.U	= (CS_CPLD << IFX_QSPI_BACON_CS_OFF)
						| (IFX_QSPI_BACON_MSB_MSK << IFX_QSPI_BACON_MSB_OFF)
						| ((26-1) << IFX_QSPI_BACON_DL_OFF)
						| (1 << IFX_QSPI_BACON_LEAD_OFF)
						| (IFX_QSPI_BACON_LAST_MSK << IFX_QSPI_BACON_LAST_OFF);
	QSPI0_DATAENTRY0.U	= 0;

	/* wait until all data received */
	while (QSPI0_STATUS.B.RXFIFOLEVEL != 4)
		;

	/* ... and read the data */
	(void)QSPI0_RXEXIT.U;
	(void)QSPI0_RXEXIT.U;
	data = QSPI0_RXEXIT.U;
	(void)QSPI0_RXEXIT.U;

	return (unsigned short)data;
}

/* read from LCD register <reg> in endless transfer mode */
static unsigned short rd_reg_endless(unsigned int reg)
{
	unsigned int data;

	/* we need 4 free entries */
	while (QSPI0_STATUS.B.TXFIFOLEVEL > (4 - 4))
		;
	/* we need 16 bit for setting the register */
	QSPI0_BACONENTRY.U	= (CS_CPLD << IFX_QSPI_BACON_CS_OFF)
						| (IFX_QSPI_BACON_MSB_MSK << IFX_QSPI_BACON_MSB_OFF)
						| ((16-1) << IFX_QSPI_BACON_DL_OFF)
						| (1 << IFX_QSPI_BACON_LEAD_OFF);
	/* mark as read register in endless mode */
	QSPI0_DATAENTRY0.U	= ((1 << 9) | (1 << 8) | reg) << 6;
	/* we need 10 clocks for reading the data + 16 for skipping first dummy */
	QSPI0_BACONENTRY.U	= (CS_CPLD << IFX_QSPI_BACON_CS_OFF)
						| (IFX_QSPI_BACON_MSB_MSK << IFX_QSPI_BACON_MSB_OFF)
						| ((26-1) << IFX_QSPI_BACON_DL_OFF)
						| (1 << IFX_QSPI_BACON_LEAD_OFF);
	QSPI0_DATAENTRY0.U	= 0;

	/* wait until all data received */
	while (QSPI0_STATUS.B.RXFIFOLEVEL != 4)
		;

	/* ... and read the data */
	(void)QSPI0_RXEXIT.U;
	(void)QSPI0_RXEXIT.U;
	data = QSPI0_RXEXIT.U;
	(void)QSPI0_RXEXIT.U;

	return (unsigned short)data;
}


/* read data from LCD in endless transfer mode */
static unsigned short rd_dat_endless(void)
{
	unsigned int data;

	/* we need 2 free entries */
	while (QSPI0_STATUS.B.TXFIFOLEVEL > (4 - 2))
		;
	/* we need 16 bit for setting the register */
	QSPI0_BACONENTRY.U	= (CS_CPLD << IFX_QSPI_BACON_CS_OFF)
						| (IFX_QSPI_BACON_MSB_MSK << IFX_QSPI_BACON_MSB_OFF)
						| ((16-1) << IFX_QSPI_BACON_DL_OFF)
						| (1 << IFX_QSPI_BACON_LEAD_OFF);
	/* no data */
	QSPI0_DATAENTRY0.U	= 0;

	/* wait until all data received */
	while (QSPI0_STATUS.B.RXFIFOLEVEL != (4 - 2))
		;

	/* ... and read the data */
	data = QSPI0_RXEXIT.U;
	(void)QSPI0_RXEXIT.U;

	return (unsigned short)data;
}

static void glcd_set_graph_window(unsigned int x0, unsigned int x1, unsigned int y0, unsigned int y1)
{
	if (ID_ILI9341 == DriverCode)
	{
		wr_cmd_endless(0x2B);	/* Page Address Set */
		wr_dat_endless(x0 >> 8);
		wr_dat_endless(x0);
		wr_dat_endless(x1 >> 8);
		wr_dat_endless(x1);
		wr_end_transfer();
		wr_cmd_endless(0x2A);	/* Column Address Set */
		wr_dat_endless(y0 >> 8);
		wr_dat_endless(y0);
		wr_dat_endless(y1 >> 8);
		wr_dat_endless(y1);
		wr_end_transfer();
	}
	else
	{
		wr_reg(0x50, x0);		/* Horizontal GRAM Start Address */
		wr_reg(0x51, x1);		/* Horizontal GRAM End   Address */
		wr_reg(0x52, y0);		/* Vertical   GRAM Start Address */
		wr_reg(0x53, y1);		/* Vertical   GRAM End   Address */
	}
}



/*******************************************************************************
* Display string on given line                                                 *
*   Parameter:     *s:        pointer to string                                *
*                  ln:        line number                                      *
*   Return:                                                                    *
*******************************************************************************/
void GLCD_displayStringLn(unsigned int ln, const char *s)
{
	unsigned int i = 0;
	unsigned int refcolumn = 0;

	/* write the string character by character on LCD */
	while ((*s != 0) && (i < (LCD_WIDTH / CHAR_WIDTH)))
	{
		GLCD_displayChar(ln, refcolumn, *s);
		refcolumn += CHAR_WIDTH;				/* next column position */
		s++;									/* next character */
		i++;									/* count characters */
	}
}
/*******************************************************************************
* Display character on given line                                              *
*   Parameter:     c :        ascii character                                  *
*                  ln:        line number                                      *
*   Return:                                                                    *
*******************************************************************************/
void GLCD_displayChar(unsigned int ln, unsigned int col, unsigned char c)
{
	/* check for characters in our font table */
	if (isfontchar(c))
	{
		c -= 32;
		GLCD_drawChar(ln, col, &ASCII_Table_1[c * CHAR_HEIGHT]);
	}
}
/*******************************************************************************
* Draw character on given position (line, coloum)                              *
*   Parameter:     x :        horizontal position                              *
*                  y :        vertical position                                *
*                 *c :        pointer to character definition                  *
*   Return:                                                                    *
*******************************************************************************/
static void GLCD_drawChar(unsigned int x, unsigned int y, const unsigned short *c)
{
	unsigned int index = 0;
	int  i = 0;
	unsigned int Xaddress = x;

	glcd_set_position(Xaddress, y);

	for (index = 0; index < CHAR_HEIGHT; ++index)
	{
		glcd_start_GRAM_write();	/* Prepare to write GRAM */
		for (i = 0; i < CHAR_WIDTH; ++i)
		{
			if ((c[index] & (1 << i)) == 0x00)
			{
				wr_dat_endless(BackColor);
			}
			else
			{
				wr_dat_endless(TextColor);
			}
		}
#ifdef USE_NORMAL_VDIR
		++Xaddress;
#else
		--Xaddress;
#endif /* USE_NORMAL_VDIR */
		wr_end_transfer();
		glcd_set_position(Xaddress, y);
	}
}
/*******************************************************************************
* Display graphical bitmap image at position x horizontally and y vertically   *
* (This function is optimized for 16 bits per pixel format, it has to be       *
*  adapted for any other bits per pixel format)                                *
*   Parameter:      x:        horizontal position                              *
*                   y:        vertical position                                *
*                   w:        width of bitmap                                  *
*                   h:        height of bitmap                                 *
*                   bitmap:   address at which the bitmap data resides         *
*   Return:                                                                    *
*******************************************************************************/
void GLCD_bitmap(unsigned int x, unsigned int y, unsigned int w, unsigned int h, const void *bitmap)
{
	unsigned int   i;
	unsigned int   len = w*h;
	unsigned short *bitmap_ptr = (unsigned short *)bitmap;

	/* set a graphic window for the bitmap */
	glcd_set_graph_window(y, y+h-1, x, x+w-1);

	glcd_set_position(y, x);

	glcd_start_GRAM_write();	/* Prepare to write GRAM */
	for (i = 0; i < len; ++i)
	{
		wr_dat_endless(*bitmap_ptr++);
	}
	wr_end_transfer();

	/* restore complete window */
	glcd_set_graph_window(0, (HEIGHT-1), 0, (WIDTH-1));
}


static int _cvt(unsigned long val, char *buf, long radix, char *digits)
{
	char temp[80];
	char *cp = temp;
	int length = 0;

	if (val == 0)
	{
		/* Special case */
		*cp++ = '0';
	}
	else
	{
		while (val)
		{
			*cp++ = digits[val % radix];
			val /= radix;
		}
	}
	while (cp != temp)
	{
		*buf++ = *--cp;
		length++;
	}
	*buf = '\0';
	return length;
}

int usr_vsprintf(char *dest, const char *fmt, va_list ap)
{
	char c, sign, *cp, *dp = dest;
	int left_prec, right_prec, zero_fill, length, pad, pad_on_right;
	char buf[32];
	long val;

	while ((c = *fmt++) != 0)
	{
		cp = buf;
		length = 0;
		if (c == '%')
		{
			c = *fmt++;
			left_prec = right_prec = pad_on_right = 0;
			if (c == '-')
			{
				c = *fmt++;
				pad_on_right++;
			}
			if (c == '0')
			{
				zero_fill = TRUE;
				c = *fmt++;
			}
			else
			{
				zero_fill = FALSE;
			}
			while (is_digit(c))
			{
				left_prec = (left_prec * 10) + (c - '0');
				c = *fmt++;
			}
			if (c == '.')
			{
				c = *fmt++;
				zero_fill++;
				while (is_digit(c))
				{
					right_prec = (right_prec * 10) + (c - '0');
					c = *fmt++;
				}
			}
			else
			{
				right_prec = left_prec;
			}
			sign = '\0';
			/* handle type modifier */
			if (c == 'l' || c == 'h')
			{
				c = *fmt++;
			}
			switch (c)
			{
				case 'd' :
				case 'u' :
				case 'x' :
				case 'X' :
					val = va_arg(ap, long);
					switch (c)
					{
						case 'd' :
							if (val < 0)
							{
								sign = '-';
								val = -val;
							}
							/* fall through */
						case 'u' :
							length = _cvt(val, buf, 10, "0123456789");
							break;
						case 'x' :
							length = _cvt(val, buf, 16, "0123456789abcdef");
							break;
						case 'X' :
							length = _cvt(val, buf, 16, "0123456789ABCDEF");
							break;
					}
					break;
				case 's' :
					cp = va_arg(ap, char *);
					length = strlen(cp);
					break;
				case 'c' :
					c = (char)va_arg(ap, long);
					*dp++ = c;
					continue;
				case '%' : /* '%%' ==> output '%' */
					*dp++ = c;
					break;
				default:
					*dp++ = '?';
			}
			pad = left_prec - length;
			if (sign != '\0')
			{
				pad--;
			}
			if (zero_fill)
			{
				c = '0';
				if (sign != '\0')
				{
					*dp++ = sign;
					sign = '\0';
				}
			}
			else
			{
				c = ' ';
			}
			if (!pad_on_right)
			{
				while (pad-- > 0)
				{
					*dp++ = c;
				}
			}
			if (sign != '\0')
			{
				*dp++ = sign;
			}
			while (length-- > 0)
			{
				c = *cp++;
				if (c == '\n')
				{
					*dp++ = '\r';
				}
				*dp++ = c;
			}
			if (pad_on_right)
			{
				while (pad-- > 0)
				{
					*dp++= ' ';
				}
			}
		}
		else
		{
			if (c == '\n')
			{
				*dp++= '\r';
			}
			*dp++ = c;
		}
	}

	*dp = '\0';

	return ((int)dp - (int)dest);
}

int usr_sprintf(char *buf, char const *fmt, ...)
{
	int ret;
	va_list ap;

	va_start(ap, fmt);
	ret = usr_vsprintf(buf, fmt, ap);
	va_end(ap);

	return ret;
}
